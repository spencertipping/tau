#!/bin/bash
set -euo pipefail
cd "$(dirname "$0")"


pull()
{
  local host=${1:-set.128}
  local path=${2:-/nvme/asqi/tau}
  rsync -azP $host:$path/bin ./
}


sync()
{
  local host=${1:-set.128}
  local path=${2:-/nvme/asqi/tau}
  rsync -azP --delete \
        dep tau.hh sigma.hh sigma tau try makefile compile_flags.txt \
        $host:$path/ &
  rsync -azP --delete dev/emsdk $host:$path/dev/ &
  wait
  date +"synced at %Y.%m%d.%H%M%S"
}


sloop()
{
  watch $0 sync "$@"
}


server_build()
{
  local host=${1:-set.128}
  local path=${2:-/nvme/asqi/tau}
  shift 2
  sync $host $path
  ssh $host bash -c ":; cd $path; $*"
  rsync -azP --delete $host:$path/bin ./
}


run()
{
  if [[ ${HOSTNAME:0:1} == i ]]; then
    server_build set.128 /nvme/asqi/tau "$@"
  else
    exec "$@"
  fi
}


cmd=$1
shift
case $cmd in
  sloop) sloop "$@"    ;;
  sync)  sync "$@"     ;;
  pull)  pull "$@"     ;;
  *)     run $cmd "$@" ;;
esac
