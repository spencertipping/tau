#!/bin/bash
set -euo pipefail
cd "$(dirname "$0")"


test_sha()
{
  echo -n "testing $@... "
  local sha1=$("$@" | cat          | sha256sum); echo -n "1"
  local sha2=$("$@" | bin/tau cat  | sha256sum); echo -n "2"
  local sha3=$("$@" | bin/tau cat2 | sha256sum); echo "3"

  if [[ $sha2 != $sha1 ]]; then
    echo -e "\033[1;31mbin/tau cat corrupts data from $@\033[0;0m"
    echo
    exit 1
  fi

  if [[ $sha3 != $sha1 ]]; then
    echo -e "\033[1;31mbin/tau cat2 corrupts data from $@\033[0;0m"
    echo
    exit 1
  fi
}


./build "$@"
bin/eta0
bin/xi
bin/psi

test_sha cat README.md
test_sha tar -c .git


echo
echo -e "\033[1;32mall passed\033[0;0m"
echo
